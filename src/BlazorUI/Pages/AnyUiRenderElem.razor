@page "/test"
@using AdminShellNS
@using static AdminShellNS.AdminShellV20;
@using AnyUi
@using BlazorUI.Shared
@using BlazorUI.Pages
@inject BlazorUI.Data.AASService SubmodelService
@inject BlazorUI.Data.blazorSessionService bi

@{
    // resharper disable all
}


@{

    // Evaluate some style attributes

    var style = new StylePile();

    if (Element is AnyUiControl ctrl)
    {
        style.Add("color", ctrl.Foreground?.HtmlRgb(), doNotSetIfNull: true);
        style.Add("background-color", ctrl.Background?.HtmlRgb(), doNotSetIfNull: true);
    }

    // elements with children

    if (Element is AnyUiGrid grid)
    {
        if (grid.Children.Count > 0 && grid.Children[0] is AnyUiSelectableTextBlock stb2
            && stb2.Text == "semanticId:")
            ;

        <AnyUiRenderGrid DisplayData="@DisplayData"
                         Session="@Session"
                         Parent="@Parent"
                         Element="@grid" />
    }
    else
    if (Element is AnyUiWrapPanel wrap)
    {
        @*<span>wp</span>*@
        <AnyUiRenderWrapPanel DisplayData="@DisplayData"
                              Session="@Session"
                              Parent="@Parent"
                              Element="@wrap" />
    }
    else
    if (Element is AnyUiStackPanel stack)
    {
        @*<span>sp</span>*@
        <AnyUiRenderStackPanel DisplayData="@DisplayData"
                               Session="@Session"
                               Parent="@Parent"
                               Element="@stack" />
    }


    // "Normal" elements

    if (Element is AnyUiHintBubble hb)
    {
        if (Session.editMode)
        {

            // outer style
            style.SetSpecifics(
                padding: hb.Padding,
                textWrapping: hb.TextWrapping,
                fontSizeRel: hb.FontSize,
                fontWeight: hb.FontWeight);

            style.Set("color", hb.Background?.HtmlRgb(), add: true, doNotSetIfNull: true);
            
            // inner style (pure text)
            var innerstyle = new StylePile();
            innerstyle.Add("color", hb.Foreground?.HtmlRgb(), doNotSetIfNull: true);

            // element
            <div class="hintbox sb1" style="@style">
                <span style="@innerstyle">@hb.Text</span>
            </div>
        }
    }
    else
    if (Element is AnyUiSelectableTextBlock stb)
    {
        if (stb.Text == "Buffer:")
            ;

        stb.DisplayData = DisplayData;

        style.SetSpecifics(
            padding: stb.Padding,
            textWrapping: stb.TextWrapping,
            fontSizeRel: stb.FontSize,
            fontWeight: stb.FontWeight);

        if (stb.TextAsHyperlink)
        {
            <a href="@stb.Text" style="@style">@stb.Text</a>
        }
        else
        {
            <span style="@style">@stb.Text</span>
        }
    }
    else
    if (Element is AnyUiTextBlock tb)
    {
        tb.DisplayData = DisplayData;

        style.SetSpecifics(
            padding: tb.Padding,
            textWrapping: tb.TextWrapping,
            fontSizeRel: tb.FontSize,
            fontWeight: tb.FontWeight);

        <span style="@style">@tb.Text</span>
    }
    else
    if (Element is AnyUiLabel chlb)
    {
        chlb.DisplayData = DisplayData;

        style.SetSpecifics(
            padding: chlb.Padding,
            fontSizeRel: chlb.FontSize,
            fontWeight: chlb.FontWeight);

        <span style="@style">@chlb.Content</span>
    }

    if (Element is AnyUiTextBox chtb)
    {
        chtb.DisplayData = DisplayData;

        //int w = chtb.Text.Length;
        //if (w > 60)
        //    w = 60;
        // size="@w"

        if (Parent is AnyUiGrid)
        {
            style += "width: 100%";
            style += "box-sizing: border-box";
        }

        <input style="@style" value="@chtb.Text"
                @onchange="@((ChangeEventArgs __e) => MyTextInput(chtb, __e.Value.ToString()))" />

        @code {
            private void MyTextInput(AnyUiTextBox chtb, string value)
            {
                chtb.setValueLambda?.Invoke(value);
                Program.signalNewData(0, Session.sessionNumber); // same tree, only values changed
            }
        }        
    }

    @if (Element is AnyUiButton chbt)
    {
        chbt.DisplayData = DisplayData;

        style.SetSpecifics(
            padding: chbt.Padding,
            fontSizeRel: chbt.FontSize);

        if (Parent is AnyUiGrid)
        {
            style += "width: 100%";
            style += "box-sizing: border-box";

            style.SetMinMaxWidth(Element);
        }

        <button style="@style" @onclick="() => MyClickButton(chbt)">@chbt.Content</button>
        @code {
            private void MyClickButton(AnyUiButton chbt)
            {
                if (chbt.SpecialAction is AnyUiSpecialActionContextMenu cntlcm)
                {
                    AnyUi.AnyUiDisplayContextHtml.specialActionContextMenuHtml(chbt, cntlcm);
                    return;
                }
                // chbt.setValueLambda?.Invoke(chbt.Content);
                AnyUi.AnyUiDisplayContextHtml.setValueLambdaHtml(chbt, chbt.Content);
            }
        }
    }

    if (Element is AnyUiCheckBox cb)
    {
        cb.DisplayData = DisplayData;

        <input type="checkbox" value="@cb.IsChecked"
               @onchange="@((ChangeEventArgs __e) => MyCheck(cb, __e.Value.ToString()))" />
        @cb.Content

        @code {
            private void MyCheck(AnyUiCheckBox cb, string value)
            {
                cb.setValueLambda?.Invoke(value.ToLower() == "true");
            }
        }
    }

    if (Element is AnyUiComboBox comb)
    {
        comb.DisplayData = DisplayData;

        style.SetSpecifics(
            padding: comb.Padding,
            fontSizeRel: comb.FontSize);

        if (Parent is AnyUiGrid)
        {
            style += "width: 100%";
            style += "box-sizing: border-box";

            style.SetMinMaxWidth(Element);
        }
        else
        {
            string w = (comb.Text.Length * 11 + 60).ToString() + "px";
            style += "width:@w";
        }

        <select class="form-control selectpicker" value="@comb.Text" style="@style"
                @onchange="@((ChangeEventArgs __e) => MyComboSelect(comb, __e.Value.ToString()))">
            @foreach (var item in comb.Items)
            {
                <option value="@item">@item</option>
            }
        </select>

        @code {
            private void MyComboSelect(AnyUiComboBox comb, string value)
            {
                comb.setValueLambda?.Invoke(value);
                Program.signalNewData(0, bi.sessionNumber); // same tree, only values changed
            }
        }
    }
}

@code {
    [Parameter]
    public AnyUiDisplayDataHtml DisplayData { get; set; }

    [Parameter]
    public Data.blazorSessionService Session { get; set; }

    [Parameter]
    public AnyUiUIElement Parent { get; set; }

    [Parameter]
    public AnyUiUIElement Element { get; set; }

}

<style>
    .hintbox {
        width: 100%;
        margin: 5px auto;
        padding: 5px;
        text-align: left;
        font-weight: normal;
        font-family: arial;
        position: relative;
    }

    .sb1:before {
        content: "";
        width: 0px;
        height: 0px;
        position: absolute;
        border-left: 10px solid;
        border-right: 10px solid transparent;
        border-top: 10px solid;
        border-bottom: 10px solid transparent;
        left: 19px;
        bottom: -19px;
    }
</style>